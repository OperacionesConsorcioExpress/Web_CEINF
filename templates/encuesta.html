<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Encuesta Reporte BI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tu CSS (no lo cambiamos aquÃ­) -->
  <link rel="stylesheet" href="{{ url_for('static', path='/css/encuesta.css') }}?v={{ static_version }}">
</head>

<body class="body">
  <main class="survey-shell">
    <!-- ================== HEADER ================== -->
    <header class="survey-header">
      <div class="title-wrap">
        <h1 class="title">Encuesta de SatisfacciÃ³n</h1>
        <p class="subtitle">Tu feedback mejora nuestros informes BI.</p>
      </div>

      <div class="brand-right">
        <div class="brand-bar" aria-label="Logos corporativos">
          <img src="/static/img/ce_logo.png" class="brand-logo ce" alt="Consorcio Express" title="Consorcio Express">
          <span class="divider" aria-hidden="true"></span>
          <img src="/static/img/power_bi.png" class="brand-logo pbi" alt="Power BI" title="Power BI">
          <span class="divider" aria-hidden="true"></span>
          <img src="/static/img/centro_info_logo.png" class="brand-logo ci" alt="Centro de InformaciÃ³n" title="Centro de InformaciÃ³n">
        </div>

        <!-- Toggle de tema -->
        <button type="button" class="btn-secondary theme-toggle" id="themeToggle" aria-label="Cambiar tema">
          ðŸŒš Oscuro
        </button>
      </div>
    </header>

    <!-- ================== FORM ================== -->
    <form method="post" action="/encuesta" class="survey-grid" id="formEncuesta">
      <!-- Reporte -->
      <section class="card reporte">
        <label class="label">Informe a evaluar</label>
        {% if nombre_reporte %}
          <input id="reporte" name="reporte" type="text" value="{{ nombre_reporte }}" class="input readonly" readonly required>
          <p class="hint">Valor recibido desde el enlace/cÃ³digo QR.</p>
        {% else %}
          {% if lista_reportes is not none %}
            <select id="reporte" name="reporte" class="select" required>
              {% if lista_reportes|length > 0 %}
                <option value="">Seleccione un reporte</option>
                {% for r in lista_reportes %}
                  <option value="{{ r }}">{{ r }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled selected>No hay reportes disponibles</option>
              {% endif %}
            </select>
            <p class="hint">Selecciona el informe que deseas evaluar.</p>
          {% else %}
            <input id="reporte" name="reporte" type="text" class="input" placeholder="Escriba el nombre del reporte" required>
            <p class="hint error">No se pudo cargar la lista desde la base de datos.</p>
          {% endif %}
        {% endif %}
      </section>

      <!-- Proceso -->
      <section class="card proceso">
        <label for="proceso" class="label">Â¿Desde quÃ© Ã¡rea (proceso) nos estÃ¡ evaluando?</label>
        {% if lista_procesos is not none and lista_procesos|length > 0 %}
          <select id="proceso" name="proceso" class="select" required>
            <option value="">Seleccione un proceso</option>
            {% for p in lista_procesos %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
          <p class="hint">Selecciona tu proceso.</p>
        {% else %}
          <input id="proceso" name="proceso" type="text" class="input" placeholder="Escribe el proceso" required>
          <p class="hint error">No se pudieron cargar los procesos desde la base.</p>
        {% endif %}
      </section>

      <!-- Subproceso (dependiente) -->
      <section class="card subproceso">
        <label for="subproceso_evaluacion" class="label">Â¿Desde quÃ© subproceso nos estÃ¡ evaluando?</label>
        <select id="subproceso_evaluacion" name="subproceso_evaluacion" class="select" required disabled>
          <option value="">Seleccione un subproceso</option>
        </select>
        <p class="hint">Este listado depende del proceso seleccionado.</p>
      </section>

      <!-- Cargo -->
      <section class="card cargo">
        <label for="cargo_evaluador" class="label">Â¿CuÃ¡l es su cargo dentro de esta Ã¡rea?</label>
        <input id="cargo_evaluador" name="cargo_evaluador" type="text" class="input" placeholder="Ej.: Analista, Jefe, Coordinador" required>
      </section>

      <!-- Calificaciones -->
      <section class="card calificaciones">
        <div class="block-head">
          <h2 class="block-title">Calificaciones</h2>
          <p class="hint">1 = Muy baja / Nada â€” 5 = Excelente / MuchÃ­simo</p>
        </div>

        <div class="matrix">
          <div class="matrix-head">
            <div class="cell"></div>
            {% for n in [1,2,3,4,5] %}
              <div class="cell center">{{ n }}</div>
            {% endfor %}
          </div>

          <div class="matrix-row">
            <div class="cell row-label">Claridad y precisiÃ³n</div>
            {% for n in [1,2,3,4,5] %}
              <div class="cell center">
                <input type="radio" id="cp_{{n}}" name="claridad_precision" value="{{n}}" required>
                <label for="cp_{{n}}" class="dot"></label>
              </div>
            {% endfor %}
          </div>

          <div class="matrix-row">
            <div class="cell row-label">Utilidad general</div>
            {% for n in [1,2,3,4,5] %}
              <div class="cell center">
                <input type="radio" id="ug_{{n}}" name="utilidad_general" value="{{n}}" required>
                <label for="ug_{{n}}" class="dot"></label>
              </div>
            {% endfor %}
          </div>

          <div class="matrix-row">
            <div class="cell row-label">Apoyo a decisiones</div>
            {% for n in [1,2,3,4,5] %}
              <div class="cell center">
                <input type="radio" id="ud_{{n}}" name="utilidad_decisiones" value="{{n}}" required>
                <label for="ud_{{n}}" class="dot"></label>
              </div>
            {% endfor %}
          </div>
        </div>
      </section>

      <!-- Frecuencia -->
      <section class="card frecuencia">
        <label class="label">Â¿Con quÃ© frecuencia consulta el informe?</label>
        <div class="segmented">
          <input type="radio" id="fq_diario"   name="frecuencia_uso" value="diario"  required>
          <label for="fq_diario">Diario</label>

          <input type="radio" id="fq_semanal"  name="frecuencia_uso" value="semanal">
          <label for="fq_semanal">Semanal</label>

          <input type="radio" id="fq_mensual"  name="frecuencia_uso" value="mensual">
          <label for="fq_mensual">Mensual</label>

          <input type="radio" id="fq_eventual" name="frecuencia_uso" value="eventual">
          <label for="fq_eventual">Eventual</label>
        </div>
      </section>

      <!-- Comentarios -->
      <section class="card comentarios">
        <label for="sugerencias_mejora" class="label">Â¿QuÃ© mejorarÃ­as de este informe?</label>
        <textarea id="sugerencias_mejora" name="sugerencias_mejora" rows="4" class="textarea" placeholder="Escribe tus comentarios..." required></textarea>
      </section>

      <!-- Footer -->
      <footer class="sticky">
        <button type="submit" class="btn-primary">Enviar respuesta</button>
      </footer>
    </form>

    <!-- ============ MODAL de AGRADECIMIENTO ============ -->
    <div id="thanksBackdrop" class="modal-backdrop" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="thanksTitle">
        <button type="button" class="modal-close" id="thanksClose" aria-label="Cerrar">Ã—</button>

        <!-- Avatar: dentro puedes poner la imagen que quieras -->
        <div class="modal-avatar">
          <!-- Sugerencia: coloca aquÃ­ tu imagen corporativa si quieres -->
          <!-- <img src="/static/img/tu_imagen.png" alt="Gracias"> -->
        </div>

        <h3 class="modal-title" id="thanksTitle">Â¡Gracias por tu aporte!</h3>
        <p class="modal-text">
          Tu retroalimentaciÃ³n nos ayuda a <b>mejorar los informes BI</b> y a tomar
          <b>mejores decisiones</b> en Consorcio Express. ðŸ™Œ
        </p>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="thanksContinue">Seguir explorando</button>
          <a class="btn-primary" href="/" id="thanksHome">Ir al inicio</a>
        </div>

        <!-- Confetti generado por JS -->
        <div class="confetti" aria-hidden="true"></div>
      </div>
    </div>
  </main>

  <!-- ================== THEME + COMPACT ================== -->
  <script>
    (function initTheme() {
      const root  = document.documentElement;
      const btn   = document.getElementById('themeToggle');
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      const saved = localStorage.getItem('theme');
      let followOS = false;

      function setTheme(mode) {
        root.setAttribute('data-theme', mode);
        btn.textContent = (mode === 'dark') ? 'ðŸŒž Claro...' : 'ðŸŒš Oscuro';
      }

      if (saved === 'light' || saved === 'dark') {
        setTheme(saved);
      } else {
        setTheme(media.matches ? 'dark' : 'light');
        followOS = true;
      }

      media.addEventListener('change', (e) => {
        if (followOS) setTheme(e.matches ? 'dark' : 'light');
      });

      btn.addEventListener('click', () => {
        const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        followOS = false;
        localStorage.setItem('theme', next);
        setTheme(next);
      });
    })();

    (function initCompact() {
      const apply = () => {
        const isSmall = window.innerHeight <= 800;
        if (!document.body.classList.contains('compact')) {
          document.body.classList.toggle('compact-auto', isSmall);
        }
      };
      apply();
      window.addEventListener('resize', apply);
    })();
  </script>

  <!-- ============ PROCESO â†’ SUBPROCESO (dependiente) ============ -->
  <script>
    (function initProcesoSubproceso() {
      const selProceso = document.getElementById('proceso');
      const selSubproc = document.getElementById('subproceso_evaluacion');
      if (!selProceso || !selSubproc) return;

      function resetSubprocesos() {
        selSubproc.innerHTML = '<option value="">Seleccione un subproceso</option>';
        selSubproc.disabled = true;
      }

      selProceso.addEventListener('change', async () => {
        const proceso = selProceso.value;
        resetSubprocesos();
        if (!proceso) return;

        try {
          const r = await fetch(`/api/subprocesos?proceso=${encodeURIComponent(proceso)}`);
          const data = await r.json();
          if (data && data.ok && Array.isArray(data.items)) {
            data.items.forEach(sp => {
              const opt = document.createElement('option');
              opt.value = sp;
              opt.textContent = sp;
              selSubproc.appendChild(opt);
            });
            selSubproc.disabled = data.items.length === 0;
          }
        } catch (err) {
          console.error('Error cargando subprocesos:', err);
        }
      });

      resetSubprocesos();
    })();
  </script>

  <!-- ============ EnvÃ­o AJAX + Modal + Confetti aleatorio ============ -->
  <script>
    (function initAjaxSubmit(){
      const form         = document.getElementById('formEncuesta');
      const backdrop     = document.getElementById('thanksBackdrop');
      const btnCloseX    = document.getElementById('thanksClose');
      const btnContinue  = document.getElementById('thanksContinue');
      const selProceso   = document.getElementById('proceso');
      const selSubproc   = document.getElementById('subproceso_evaluacion');
      const confettiBox  = backdrop.querySelector('.confetti');

      // --------- Genera confetti aleatorio ----------
      function buildConfetti(n = 120){
        if (!confettiBox) return;
        confettiBox.innerHTML = '';

        const colors = ['#5076E2','#83A4FF','#3F5DB2','#2BC14B','#16A038','#F2C94C','#BBCCF9'];

        for (let i=0; i<n; i++){
          const s = document.createElement('span');

          // PosiciÃ³n inicial random (0â€“100%)
          s.style.left = (Math.random()*100).toFixed(2) + '%';

          // TamaÃ±o 6â€“12 px
          s.style.setProperty('--size', (6 + Math.random()*6).toFixed(1) + 'px');

          // Deriva horizontal en mitad y final (-30..30 / -60..60 px)
          s.style.setProperty('--tx50',  ((Math.random()*60)  - 30).toFixed(0) + 'px');
          s.style.setProperty('--tx100', ((Math.random()*120) - 60).toFixed(0) + 'px');

          // DuraciÃ³n 2.4â€“4.0 s
          s.style.setProperty('--dur',   (2.4 + Math.random()*1.6).toFixed(2) + 's');

          // Retardo 0â€“0.8 s
          s.style.setProperty('--delay', (Math.random()*0.8).toFixed(2) + 's');

          // Color
          s.style.setProperty('--conf-color', colors[(Math.random()*colors.length)|0]);

          confettiBox.appendChild(s);
        }
      }

      // --------- Modal open/close ----------
      function openModal(){
        // Confetti nuevo en cada apertura
        buildConfetti(120);

        // Abre modal y dispara animaciÃ³n
        backdrop.classList.add('is-open');
        backdrop.classList.remove('celebrate'); // reset anim
        void backdrop.offsetWidth;              // reflow
        backdrop.classList.add('celebrate');    // start anim
        document.body.style.overflow = 'hidden';
      }

      function closeModal(){
        backdrop.classList.remove('celebrate');
        backdrop.classList.remove('is-open');
        document.body.style.overflow = '';
      }

      // Limpia el formulario y deja subproceso deshabilitado
      function resetForm(){
        form.reset();

        if (selProceso && !selProceso.hasAttribute('readonly')) {
          selProceso.value = "";
        }
        if (selSubproc) {
          selSubproc.innerHTML = '<option value="">Seleccione un subproceso</option>';
          selSubproc.disabled = true;
        }

        const firstEditable = form.querySelector('input:not([readonly]), select:not([disabled]), textarea');
        if (firstEditable) firstEditable.focus();
      }

      // Cerrar modal
      btnCloseX.addEventListener('click', closeModal);
      btnContinue.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (e)=>{ if (e.target === backdrop) closeModal(); });

      // Interceptar submit
      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();

        const fd = new FormData(form);

        try{
          const resp = await fetch(form.action, { method: 'POST', body: fd });
          if (!resp.ok) {
            const msg = await resp.text();
            alert('No se pudo guardar la encuesta.\n\n' + msg);
            return;
          }

          const data = await resp.json();
          if (data && data.ok) {
            openModal();
            resetForm();
          } else {
            alert('No se pudo guardar la encuesta. Intenta nuevamente.');
          }
        }catch(err){
          console.error('Error enviando encuesta:', err);
          alert('OcurriÃ³ un error al enviar. Verifica tu conexiÃ³n e intenta de nuevo.');
        }
      });
    })();
  </script>
</body>
</html>
